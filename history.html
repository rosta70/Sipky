<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Výsledková listina Šipky</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <h1>Historie Her a Výsledková listina</h1>

    <div id="setup-section" style="text-align: left; padding: 10px 20px;">
        <a href="index.html" style="text-decoration: none;">
            <button style="background-color: #34495e;">← Zpět k počítadlu skóre</button>
        </a>
        
        <button id="export-history-btn" style="background-color: #27ae60;">Exportovat VŠECHNY hry (JSON)</button>
        
        <label for="import-file" style="background-color: #3498db; color: white; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px;">
            Importovat JSON
        </label>
        <input type="file" id="import-file" accept=".json" style="display: none;">

        <button id="clear-history-btn" style="background-color: #c0392b; float: right;">Smazat historii</button>
    </div>

    <div id="player-overview-container">
        <h2>Přehled Hráčů</h2>
        <table id="player-stats-table"></table>
    </div>

    <div id="history-container">
        <h2>Detailní Průběh Her</h2>
        <p id="no-history-msg">Žádná uložená historie her.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            document.getElementById('import-file').addEventListener('change', importHistory);
            document.getElementById('export-history-btn').addEventListener('click', exportHistory);
            document.getElementById('clear-history-btn').addEventListener('click', clearHistory);
        });

        const HISTORY_STORAGE_KEY = 'darts_scorer_history';
        const SAVED_GAME_KEY = 'darts_scorer_saved_game'; // Klíč pro rozehranou hru

        // --- HLAVNÍ FUNKCE PRO NAČTENÍ A VYKRESLENÍ ---
        function loadHistory() {
            const allHistory = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            const container = document.getElementById('history-container');
            const overviewTable = document.getElementById('player-stats-table');
            const noMsg = document.getElementById('no-history-msg');
            container.innerHTML = '';
            overviewTable.innerHTML = '';

            if (allHistory.length === 0) {
                container.appendChild(noMsg);
                document.getElementById('export-history-btn').disabled = true;
                return;
            }
            document.getElementById('export-history-btn').disabled = false;

            // 1. Přehled hráčů a výher
            renderPlayerOverview(allHistory, overviewTable);
            
            // 2. Detailní tabulka her
            renderGameDetails(allHistory, container);
        }

        function renderPlayerOverview(allHistory, tableElement) {
            const stats = {};
            
            allHistory.forEach(game => {
                const winnerName = game.winner;
                
                game.players.forEach(p => {
                    if (!stats[p.name]) {
                        stats[p.name] = { wins: 0, games: 0, totalDoubles: 0, totalTriples: 0 };
                    }
                    stats[p.name].games++;
                    if (p.name === winnerName) {
                        stats[p.name].wins++;
                    }
                    // Sčítání statistik ze všech her
                    stats[p.name].totalDoubles += p.stats ? p.stats.doubles : 0;
                    stats[p.name].totalTriples += p.stats ? p.stats.triples : 0;
                });
            });

            // Vytvoření HTML tabulky
            let html = '<tr><th>Jméno</th><th>Výhry</th><th>Odehrané hry</th><th>Celkem Double</th><th>Celkem Triple</th></tr>';
            
            const sortedPlayers = Object.keys(stats).sort((a, b) => stats[b].wins - stats[a].wins);

            sortedPlayers.forEach(name => {
                const s = stats[name];
                html += `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td>${s.wins}</td>
                        <td>${s.games}</td>
                        <td>${s.totalDoubles}</td>
                        <td>${s.totalTriples}</td>
                    </tr>
                `;
            });
            tableElement.innerHTML = html;
        }

        function renderGameDetails(allHistory, containerElement) {
            allHistory.reverse().forEach((game, index) => {
                const gameNumber = allHistory.length - index; 

                // Detailní tabulka pro každou hru
                let playerDetails = `<table class="game-detail-table"><tr><th>Hráč</th><th>Zbývalo</th><th>Double/Triple</th></tr>`;
                game.players.forEach(p => {
                    const d = p.stats ? p.stats.doubles : 'N/A';
                    const t = p.stats ? p.stats.triples : 'N/A';
                    playerDetails += `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.finalScore}</td>
                            <td>D: ${d}, T: ${t}</td>
                        </tr>
                    `;
                });
                playerDetails += `</table>`;
                
                const gameElement = document.createElement('div');
                gameElement.className = 'history-card';
                gameElement.innerHTML = `
                    <h3>Hra #${gameNumber} (${game.gameType}x01)</h3>
                    <p>Datum: <strong>${game.date}</strong></p>
                    <p>Vítěz: <strong style="color: ${game.winner === 'N/A' ? 'gray' : '#27ae60'};">${game.winner}</strong></p>
                    ${playerDetails}
                `;
                containerElement.appendChild(gameElement);
            });
            
            // Přidání stylů pro tabulky
            const style = document.createElement('style');
            style.innerHTML = `
                .history-card {
                    background-color: #ffffff;
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    margin: 15px auto;
                    max-width: 600px;
                    border-left: 5px solid #1a5273;
                }
                #player-stats-table, .game-detail-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 10px;
                }
                #player-stats-table th, #player-stats-table td, .game-detail-table th, .game-detail-table td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: left;
                }
                #player-stats-table th {
                    background-color: #f2f2f2;
                }
            `;
            document.head.appendChild(style);
        }

        // --- FUNKCE PRO EXPORT / IMPORT ---
        
        function exportHistory() {
            const data = localStorage.getItem(HISTORY_STORAGE_KEY);
            const savedGame = localStorage.getItem(SAVED_GAME_KEY);
            
            // Exportujeme jak historii, tak rozehranou hru do JEDNOHO souboru pro snadný import
            const exportData = {
                history: JSON.parse(data || '[]'),
                savedGame: savedGame ? JSON.parse(savedGame) : null
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sipky_full_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Historie a rozehraná hra byly úspěšně exportovány!");
        }

        function importHistory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.history) {
                        alert("Chyba: Nahraný soubor neobsahuje platnou strukturu exportu (chybí 'history' pole).");
                        return;
                    }
                    
                    // 1. Import historie
                    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(importedData.history));
                    
                    // 2. Import rozehrané hry, pokud existuje
                    if (importedData.savedGame) {
                        localStorage.setItem(SAVED_GAME_KEY, JSON.stringify(importedData.savedGame));
                        alert(`Historie ${importedData.history.length} her a rozehraná hra byly úspěšně naimportovány.`);
                    } else {
                         localStorage.removeItem(SAVED_GAME_KEY);
                         alert(`Historie ${importedData.history.length} her byla úspěšně naimportována. Žádná rozehraná hra nebyla nalezena.`);
                    }

                    loadHistory(); 
                    
                } catch (error) {
                    alert("Chyba při čtení souboru. Zkontrolujte, zda se jedná o platný JSON formát.");
                    console.error("Import Error:", error);
                }
            };
            reader.readAsText(file);
        }

        function clearHistory() {
             if (confirm("Opravdu chcete smazat CELOU historii uložených her A rozehranou hru?")) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                localStorage.removeItem(SAVED_GAME_KEY);
                alert("Historie a rozehraná hra byly smazány.");
                loadHistory(); 
            }
        }
    </script>
</body>
</html>
